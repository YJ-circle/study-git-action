name: Check GPG Signatures

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-signatures:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git user identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches
        run: git fetch --all

      - name: Check for unsigned commits
        id: check
        run: |
          COMMITS=$(git log origin/${{ github.base_ref }}..origin/${{ github.head_ref }} --pretty=format:"%H %G?" || echo "")
          UNSIGNED=0

          if [ -z "$COMMITS" ]; then
            echo "No commits found for comparison. Exiting."
            echo "unsigned=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          while read -r COMMIT STATUS; do
            if [ "$STATUS" != "G" ]; then
              echo "Unsigned or unverified commit: $COMMIT (status: $STATUS)"
              UNSIGNED=1
            fi
          done <<< "$COMMITS"
          echo "unsigned=$UNSIGNED" >> "$GITHUB_OUTPUT"

      - name: Comment if unsigned commits
        if: steps.check.outputs.unsigned == '1'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ğŸš« ì´ PRì—ëŠ” **GPG ì„œëª…ë˜ì§€ ì•Šì€ ì»¤ë°‹**ì´ í¬í•¨ë˜ì–´ ìˆì–´ìš”.\n\nëª¨ë“  ì»¤ë°‹ì„ ì„œëª…(`git commit -S`)í•˜ê³  ë‹¤ì‹œ pushí•´ì£¼ì„¸ìš” ğŸ™"
            })

      - name: Close PR if unsigned commits
        if: steps.check.outputs.unsigned == '1'
        uses: peter-evans/close-pull@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          comment: "ğŸš« GPG ì„œëª…ì´ ì—†ëŠ” ì»¤ë°‹ì´ í¬í•¨ë˜ì–´ ìˆì–´ ì´ PRì€ ìë™ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤. \n\n ëª¨ë“  ì»¤ë°‹ì„ \`git commit -S\`ë¡œ ì„œëª…í•´ì£¼ì„¸ìš”."
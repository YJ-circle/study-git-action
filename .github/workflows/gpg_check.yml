name: Check GPG Signatures

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-signatures:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Set Git user identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Check for unsigned commits
        run: |
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%H %G?")
          UNSIGNED=0
          while read -r COMMIT STATUS; do
            if [ "$STATUS" != "G" ]; then
              echo "Unsigned or unverified commit: $COMMIT (status: $STATUS)"
              UNSIGNED=1
            fi
          done <<< "$COMMITS"
          echo "UNSIGNED=$UNSIGNED" >> $GITHUB_ENV

      - name: Comment if unsigned commits
        if: env.UNSIGNED == '1'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ğŸš« ì´ PRì—ëŠ” **GPG ì„œëª…ë˜ì§€ ì•Šì€ ì»¤ë°‹**ì´ í¬í•¨ë˜ì–´ ìˆì–´ìš”.\n\nëª¨ë“  ì»¤ë°‹ì„ ì„œëª…(`git commit -S`)í•˜ê³  ë‹¤ì‹œ pushí•´ì£¼ì„¸ìš” ğŸ™"
            })

      - name: Close PR if unsigned commits
        if: env.UNSIGNED == '1'
        uses: peter-evans/close-pull@v3
        with:
          comment: "ğŸš« GPG ì„œëª…ì´ ì—†ëŠ” ì»¤ë°‹ì´ í¬í•¨ë˜ì–´ ìˆì–´ ì´ PRì€ ìë™ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤. ëª¨ë“  ì»¤ë°‹ì„ `git commit -S`ë¡œ ì„œëª…í•´ì£¼ì„¸ìš”."
permissions:
  context: write
  issues: write
  pull-requests: write
